<html>
  <head>
    <title>Lystra</title>
    <script>
      function lystra_fetch(path, cb){
        var ajax = new XMLHttpRequest();
        ajax.onreadystatechange = function(){
          if(ajax.readyState == 4){
            cb(ajax);
          }
        };
        ajax.open('GET', path);
        ajax.setRequestHeader('Accept', 'text/uri-list, text/html');
        ajax.send();
      }

      function lystra_set_interval(uri){
        var track = lystra_track(uri);
        track.interval = setInterval(lystra_update_progress, 1000);
      }

      function lystra_clear_interval(uri){
        var track = lystra_track(uri);
        if(track.interval){
          clearInterval(track.interval);
        }
      }

      var trackary = {};
      function lystra_track(uri){
        var track = trackary[uri];
        if(!track){
          track = {uri: uri};
          trackary[uri] = track;
        }
        return track;
      }

      var cardNames = ['library', /*'queue',*/ /*'player', 'history'*/];

      function lystra_switch(chosen){
        for(var index in cardNames){
          var card = cardNames[index];
          var elm = lystra_id(card + '_wrapper');
          elm.style.display = (card == chosen ? '' : 'none');
          var button = lystra_id(card + '_button');
          lystra_classname(button, 'lystra_selected', card == chosen);
        }
      }

      function lystra_classname(elm, classname, condition){
        var classes = elm.getAttribute('class') || '';
        var regex = new RegExp('( |^)' + classname + '( |$)');
        if(condition){
          if(!regex.test(classes)){
            classes += ' ' + classname;
          }
        } else {
          classes = classes.replace(regex, '');
        }
        elm.setAttribute('class', classes);
      }

      function lystra_join(array, delim){
        if(array.length < 1){
          return '';
        }
        var ret = array[0];
        for(var i=1;i!=array.length;i++){
          ret += delim + array[i];
        }
        return ret;
      }

      function lystra_make(tagName, options){
        var rv = document.createElement(tagName);
        var parentNode = null;
        for(var option in options){
          var value = options[option];
          if(option == 'text'){
            rv.innerHTML = value;
          } else if (option == 'onclick'){
            rv.onclick = value;
          } else if(option == 'parent'){
            parentNode = value;
          } else {
            rv.setAttribute(option, value);
          }
        }
        if(parentNode){
          parentNode.appendChild(rv);
        }
        return rv;
      }

      function lystra_find(selector, elm){
        var elm = elm || document;
        var nodes = elm.querySelectorAll(selector);
        return nodes;
      }

      function lystra_id(id){
        return document.getElementById(id);
      }

      function Playlist(uri){
        this.uri = uri;
        this.isPlaylist = true;
      }
      function Track(uri){
        this.uri = uri;
        this.isPlaylist = false;
      }

      var mimeToResponseHandlerMap = {
        'text/html' : function (xhr){
          var linkpattern = /a\s+href="([^"]+)(\.ogg|\.wav|\.aac|\.mp3|\.flac|\.m4a|\.wma|\/)"/g
          var links = [];
          var text = xhr.responseText;
          while(true){
            var match = linkpattern.exec(text);
            if(match == null){
              break;
            }
            var href = match[1] + match[2];
            if(match[2] == "/"){
              links.push(new Playlist(href));
            } else {
              var track = new Track(href);
              links.push(track);
            }
          }
          return links;
        },
        'text/uri-list': function(xhr){
            var links = [];
            var lines = xhr.responseText.split('\r\n');
            for(var index in lines){
                var line = lines[index];
                if(line == "" || line == "lystra.html"){
                  continue;
                }
                if(line[line.length - 1] == "/"){
                  links.push(new Playlist(line));
                } else {
                  var track = new Track(line);
                  links.push(track);
                }
            }
            return links;
        }
      };

      function lystra_toggle_play_pause(forcePlay){
        var audio = lystra_id('audio');
        if(!audio.src){
          lystra_play_next();
        } else {
          if(audio.paused || forcePlay){
            audio.play();
          } else {
            audio.pause();
          }
        }
      }

      function lystra_pause(pause){
        var audio = lystra_id('audio');
        if(!audio.src){
          lystra_play_next();
        } else {
          if(pause){
            audio.play();
          } else {
            audio.pause();
          }
        }
      }

      function lystra_history_add(uri){
        var parent = lystra_id('history_body');
        parent.insertBefore(lystra_make('div', {
          text : uri,
          'class': 'track',
          'data-uri': uri
        }), parent.firstChild);
      }

      function lystra_play_next(){
        var audio = lystra_id('audio');
        var current = audio.getAttribute('data-uri');
        if(current){
          lystra_history_add(current);
          lystra_queue(current);
        }
        var next = null;
        var tracks = lystra_find('#queue_body .track');
        if(tracks && tracks.length > 0){
          var track = tracks[0];
          var audio = lystra_id('audio');
          next = track.getAttribute('data-uri');
        }
        lystra_id('nowplaying').innerHTML = next ? decodeURI(next) : '';

        if(next){
          audio.ondurationchange = lystra_update_progress;
          audio.src = next;
          audio.setAttribute('data-uri', next);
        } else {
          audio.removeAttribute('src');
          audio.removeAttribute('data-uri');
        }
        lystra_id('countup').innerHTML = "0";
        lystra_id('countdown').innerHTML = "0";
        lystra_set_interval(next);
        if(next){
          lystra_toggle_play_pause(true);
        }
      }

      function lystra_detach(elm){
        if(elm){
          elm.parentNode.removeChild(elm);
        }
      }

      function lystra_update_progress(){
        var audio = lystra_id('audio');

        var countdown = lystra_format_seconds(audio.duration);
        var countup = lystra_format_seconds(audio.currentTime);

        lystra_id('countdown').innerHTML = countdown;
        lystra_id('countup').innerHTML = countup;

        if(countdown == countup){
          lystra_clear_interval(audio.getAttribute('data-uri'));
        }
      }

      function lystra_format_seconds(time){
        var minutes = Math.floor(time / 60);
        var seconds = Math.floor(time % 60);
        if(minutes < 10){
          minutes = "0" + minutes;
        }
        if(seconds < 10){
          seconds = "0" + seconds;
        }
        return minutes + ':' + seconds;
      }

      function lystra_queue(uri){
        var track = lystra_track(uri);
        if(track.queueElement){
          lystra_classname(track.libraryElement, 'queued', false);
          lystra_detach(track.queueElement);
          track.queueElement = null;
        } else {
          track.queueElement = lystra_make('div', {
            text : decodeURI(track.uri),
            'class': 'track',
            'data-uri': track.uri,
            onclick: function(){
              lystra_queue(uri);
            },
            parent: lystra_id('queue_body')
          });
          lystra_classname(track.libraryElement, 'queued', true);
        }
        //lystra_update_queue_posish();
      }

    /*  function lystra_update_queue_posish(){
        var queueTracks = lystra_find('#queue_body .track');
        var libraryTracks = lystra_find('#library_body .track');
        for(var i = 0; i != queueTracks.length; i++){
          var dataUri = queueTracks[i].getAttribute('data-uri');
          for(var j = 0; j != libraryTracks.length; j++){
            if(libraryTracks[j].getAttribute('data-uri') == dataUri){
              lystra_classname(libraryTracks[j], 'queued', true);
            }
          }
        }
      }*/

      function lystra_load(){
        if(!document.querySelectorAll){
          alert('No querySelectorAll');
        }
        try {
          var url = window.location.pathname;
          var lastslash = url.lastIndexOf('/');
          url = url.substring(0, lastslash+1);
          lystra_expand(lystra_id('library_button'), url);
        } catch (error) {
          alert(error);
        }
      }



      function lystra_expand(expandButton, url){
        lystra_switch('library');
        var folderContent = expandButton.parentNode.querySelector('.folder_content');
        lystra_display(folderContent, true);
        lystra_display(expandButton.parentNode.querySelector('.collapse_button'), true);
        lystra_display(expandButton.parentNode.querySelector('.expand_button'), false);

        if(folderContent.getAttribute('data-fetched') == 'true'){
          return;
        }

        var lastslash = url.lastIndexOf('/', url.length - 2);
        var parentUri = null;
        if(lastslash != -1){
          parentUri = url.slice(0, lastslash + 1);
        }

        var baseUrl = url;
        lystra_fetch(url, function(xhr){
          var mime = xhr.getResponseHeader('Content-Type');
          folderContent.setAttribute('data-fetched', 'true');
          mime = mime.split(';')[0];
          var responseHandler = mimeToResponseHandlerMap[mime];
          var links = responseHandler(xhr);
          for(var index in links){
            var link = links[index];
            if(link.uri == parentUri){
                continue;
            }
            var onclick = link.isPlaylist ?
              function(){
                lystra_expand(this, this.getAttribute('data-uri'));
              }: function(){
                //lystra_queue(new Track(this.getAttribute('data-uri')));
                lystra_queue(this.getAttribute('data-uri'));
              };
            var cssclass = link.isPlaylist ? 'playlist' : 'track';
            var titlePrefix = link.isPlaylist ? '' : '';
            var wrapper = lystra_make('div', {
              'class': 'folder_wrapper',
              parent: folderContent
            });
            var trackUri = baseUrl + link.uri;
            lystra_track(trackUri).libraryElement =
              lystra_make('div', {
              text : titlePrefix + decodeURI(link.uri),
              'data-uri': trackUri,
              onclick : onclick,
              'class': cssclass + ' expand_button',
              parent: wrapper
            });
            if(link.isPlaylist){
              lystra_make('div', {
                text : decodeURI(link.uri),
                'class': 'playlist collapse_button',
                onclick : function(){
                  lystra_collapse(this);
                },
                style: 'display:none',
                parent: wrapper
              });
              lystra_make('div', {
                'class': 'folder_content',
                style: 'display:none',
                parent: wrapper
              });
            }
          }
        });
      }

      function lystra_collapse(elm){
        lystra_display(elm.parentNode.querySelector('.folder_content'), false);
        lystra_display(elm.parentNode.querySelector('.collapse_button'), false);
        lystra_display(elm.parentNode.querySelector('.expand_button'), true);
      }

      function lystra_display(elm, display){
        if(elm){
          elm.style.display = display ? '' : 'none';
        }
      }

      function lystra_queue_all(){
        var libraryBody = lystra_id('library_body');
        var tracks = lystra_find(".track", libraryBody);
        for(var i = 0; i != tracks.length; i++){
          var trackElm = tracks[i];
          lystra_queue(trackElm.getAttribute('data-uri'));
        }
      }

    </script>
    <style>
      div.card {
        width:100%;
        font-family: sans-serif;
        margin-top: 5px;
      }
      div.card_header {
        text-align: center;
        padding: 12px;
        /*border-bottom-style: dotted;
        border-bottom-color: black;
        border-bottom-width: 1px;*/
      }
      div.card_body {
        text-align: center;
        /*padding-top:10px;*/
        /*background-color: khaki;*/
      }
      .card_header_button.lystra_selected {
        font-weight: bold;
        padding: 5px;

        border-width: 2px;
        /*border-bottom-style: none;*/
      }
      .card_header_button {
        font-size: small;
        margin: 5px;
        padding: 5px;
        border-radius: 5px 5px 5px 5px;
        border-width: 1px;
        border-color: black;
        border-style: solid;
        background-color: khaki;
      }
      .button {
        font-size: small;
        text-align: center;
        background-color: khaki;
      }

      .folder_content {
        padding-left: 4%;
        /*padding-right: 0%;*/
      }

      .folder_wrapper {
        font-size: small;
        /*border: 1px dotted grey;*/
      }

      .queued {
        font-style: italic;
      }
      .track {
        margin: 5px;
        padding: 5px;
        border-top: 1px grey dotted;

        border-radius: 5px 5px 5px 5px;
        border-width: 1px;
        border-color: black;
        border-style: solid;
        background-color: khaki;
      }

      .playlist {
        margin: 5px;
        padding: 5px;
        border-top: 1px grey dotted;

        border-radius: 5px 5px 5px 5px;
        border-width: 1px;
        border-color: black;
        border-style: solid;
        background-color: khaki;
      }

      .collapse_button  {
        font-weight: bold;
        padding: 5px;
        border: solid 2px black;
      }

      /*#playercontrols {
        position: absolute;
        left: 0px;
        top: 0px;
        width: 100%;
        border-bottom: 1px black solid;
        background: khaki;
        text-align: center;
      }*/

      </style>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
  </head>
  <body onload="lystra_load()">
    <div class="card" tabindex="0">
        <div class="card_header">
          <div id="playercontrols" class="card_header_button">
            <audio id="audio" onended="lystra_play_next()"></audio>
            <div>
              <span id="countup"></span>
              <button onclick="lystra_toggle_play_pause()">Play/Pause</button>
              <!-- span onclick="lystra_pause(true)">||</span>
              <span onclick="lystra_pause(false)">&gt;</span -->
              <button onclick="lystra_pause(); lystra_play_next()">Skip</button>
              <span id="countdown"></span>
            </div>
          <div id="nowplaying"></div>
        </div>
        <!-- div id="queue_button" class="card_header_button" onclick="lystra_switch('queue')">Show Play Queue</div -->
        <!-- div id="library_button" class="card_header_button" onclick="lystra_switch('library')">Show Library</div -->
        <!-- div id="player_button" class="card_header_button" onclick="lystra_switch('player')">Now Playing</div -->
        <!--  div id="history_button" class="card_header_button" onclick="lystra_switch('history')">Show History</div -->
      </div>

      <div id="queue_wrapper" class="folder_wrapper">
        <div
             class="card_body playlist expand_button"
             onclick="lystra_expand(this)">Play Queue</div>
        <div
             class="card_body playlist collapse_button"
             style="display:none"
             onclick="lystra_collapse(this)">Play Queue</div>
        <div id="queue_body" style="display:none" class="card_body folder_content"></div>
      </div>


      <div id="library_wrapper" class="folder_wrapper">
        <div id="library_button"
             data-fetched="true"
             class="card_body playlist expand_button"
             onclick="lystra_expand(this)">Library</div>
        <div data-fetched="true"
             style="display:none"
             class="card_body playlist collapse_button"
             onclick="lystra_collapse(this)">Library</div>
        <div id="library_body" class="card_body folder_content">
        </div>
      </div>



      <!-- div id="player_wrapper">
      <div id="player_body" class="card_body">
        <! --  div id="nowplaying"></div>
          <audio id="audio" onended="lystra_play_next()"></audio>
         <div>
         <span id="countup"></span>
         <button onclick="lystra_toggle_play_pause()">Play/Pause</button>
         <span id="countdown"></span>
       </div - >
      </div>
    </div-->

<div id="history_wrapper" class="folder_wrapper">
    <div id="history_button"
         class="card_body playlist expand_button"
         onclick="lystra_expand(this)">History</div>
    <div id="history_button"
         class="card_body playlist collapse_button"
         style="display:none"
         onclick="lystra_collapse(this)">History</div>
      <div id="history_body" class="card_body folder_content"></div>
    </div>
  </div>


  </body>
</html>
